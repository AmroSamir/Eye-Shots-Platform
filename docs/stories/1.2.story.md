# Story 1.2: User Authentication Setup

## Status
Draft

## Story
**As an** administrator,
**I want** to manage user accounts for both internal team members and clients,
**so that** only authorized users can access the platform.

## Acceptance Criteria
1. The system integrates with the template's useAuth provider.
2. Users can sign up for a new account.
3. Users can sign in with their credentials.
4. Users can sign out.
5. The system can differentiate between "Internal Team" and "Client" user types upon registration or by admin assignment.

## Tasks / Subtasks
- [ ] Task 1: Replace NextAuth with Clerk authentication integration (AC: 1)
  - [ ] Install Clerk SDK and dependencies
  - [ ] Configure Clerk environment variables
  - [ ] Replace NextAuth configuration with Clerk setup
  - [ ] Update auth.ts to use Clerk authentication
- [ ] Task 2: Implement user sign-up functionality (AC: 2)
  - [ ] Create Clerk sign-up component integration
  - [ ] Configure sign-up flow with user type selection
  - [ ] Integrate with Convex user creation
  - [ ] Test sign-up process end-to-end
- [ ] Task 3: Implement user sign-in functionality (AC: 3)
  - [ ] Create Clerk sign-in component integration
  - [ ] Update existing sign-in pages to use Clerk
  - [ ] Configure authentication redirects
  - [ ] Test sign-in process with existing users
- [ ] Task 4: Implement user sign-out functionality (AC: 4)
  - [ ] Update sign-out logic to use Clerk
  - [ ] Ensure proper session cleanup
  - [ ] Update user dropdown/profile menu
  - [ ] Test sign-out functionality
- [ ] Task 5: Implement user type differentiation system (AC: 5)
  - [ ] Create user type selection during registration
  - [ ] Set up Convex user schema integration
  - [ ] Implement admin assignment interface
  - [ ] Create user type validation and storage

## Dev Notes

### Previous Story Insights
**Key learnings from Story 1.1**:
- Ecme Next.js template successfully initialized with Next.js 15.3.1
- Template includes NextAuth-based authentication system (current setup)
- Development server running successfully on localhost:3000
- All dependencies installed and verified (701 packages)

### Technical Architecture Requirements
**Authentication Architecture** [Source: architecture/tech-stack.md]:
- **Authentication**: Clerk (Latest) - Manages all user sign-up, sign-in, session management, and future subscriptions
- Must replace existing NextAuth implementation with Clerk integration

**High-Level Architecture Integration** [Source: architecture/high-level-architecture.md]:
- Auth Flow: Frontend (Ecme Next.js) â†’ Clerk Authentication via Clerk SDK
- Clerk provides webhooks and auth state management
- Backend integration: Convex functions can call Clerk for user management

**Database Schema Requirements** [Source: architecture/database-schema-convex.md]:
```typescript
users: defineTable({
  clerkId: v.string(),           // Clerk user identifier
  email: v.string(),
  displayName: v.string(),
  type: v.union(v.literal("Internal"), v.literal("Client")),
  role: v.union(v.literal("Admin"), v.literal("Project Manager"), v.literal("Creative"), v.literal("Client")),
}).index("by_clerk_id", ["clerkId"])
```

### Current Template Analysis
**Existing Authentication Setup**:
- Template uses NextAuth with GitHub, Google, and Credentials providers
- Auth configuration in `src/configs/auth.config.ts`
- Main auth setup in `src/auth.ts`
- Sign-in pages: `/sign-in`, `/sign-up`, `/forgot-password`, `/reset-password`

**Migration Required**:
- Replace NextAuth implementation with Clerk
- Update AuthProvider and SessionContext components
- Modify existing auth forms to use Clerk components
- Update middleware and route protection

### File Locations
**Files to Modify**:
- `src/auth.ts` - Replace with Clerk configuration
- `src/configs/auth.config.ts` - Replace with Clerk config
- `src/components/auth/AuthProvider/` - Update to use Clerk
- `src/components/auth/SignIn/` - Integrate Clerk sign-in
- `src/components/auth/SignUp/` - Integrate Clerk sign-up
- `src/middleware.ts` - Update auth middleware for Clerk

**Files to Create**:
- `convex/schema.ts` - Convex schema with user table
- `convex/users.ts` - User management functions
- Environment variables configuration for Clerk

### Integration Requirements
**Clerk Setup Dependencies**:
- Install `@clerk/nextjs` package
- Configure Clerk publishable and secret keys
- Set up Clerk webhook endpoints for user synchronization
- Create Convex functions for user data management

**User Type Implementation**:
- Custom user metadata in Clerk for user types
- Convex integration for user type storage and validation
- Admin interface for user type assignment (future story preparation)

### Testing Requirements
**Testing Standards** [Source: architecture/tech-stack.md]:
- Use Jest & React Testing Library for authentication flow testing
- Test sign-up, sign-in, sign-out workflows
- Verify user type assignment and differentiation
- Test integration between Clerk and Convex user management

### Technical Constraints
**Architecture Compliance**:
- Must use Clerk (not NextAuth) per tech stack requirements
- Must integrate with planned Convex backend structure
- Must maintain Ecme component compatibility
- Must preserve existing route protection patterns

### Project Structure Notes
**Structural Conflicts Identified**:
- Template uses NextAuth, architecture requires Clerk (breaking change)
- Requires migration of existing authentication patterns
- Need to preserve Ecme template's auth UI components while changing backend
- Must ensure compatibility with planned Convex integration

**Migration Strategy**:
- Gradual replacement: Install Clerk alongside NextAuth initially
- Update components one by one to use Clerk
- Remove NextAuth dependencies once migration complete
- Maintain existing route structure and user flows

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-09 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during development*

### Debug Log References
*To be populated during development*

### Completion Notes List
*To be populated during development*

### File List
*To be populated during development*

## QA Results
*Results from QA Agent QA review will be populated here after story completion*